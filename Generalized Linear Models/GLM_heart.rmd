---
title: "Modele liniowe heart"
date: "19 06 2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(gridExtra)
library(ResourceSelection)
library(statmod)
```

```{r}
heart <- read.csv("heart.csv")
```

Będziemy zajmować się zbiorem danych zawierającym 303 obserwacje 6 zmiennych. Mówi on o większym bądź mniejszym prawdopodobieństwie ataku serca przez wzgląd na różne czynniki. Na początku spójrzmy na opis naszych predyktorów.


Nazwa zmiennej | Opis                                                                        |
---------------|-----------------------------------------------------------------------------|
`age`          | Wiek pacjenta                                                               |
`sex`          | Płeć pacjenta (0 = Mężczyzna, 1 = Kobieta)                                  |
`exng`         | Dławica piersiowa wywołana wysiłkiem fizycznym (1 = tak, 0 = nie)           |
`trtbps`       | Spoczynkowe ciśnienie krwi                                                  |
`chol`         | Ilość w cholesterol w mg/dl pobrany przez czujnik BPM                       |
`thalachh`     | Maksymalne osiągnięte tętno                                                 |
`output`       | 0 = mniejsza szansa na atak serca, 1 = większa szansa na atak serca         |

Podsumujmy nasze dane

```{r}

summary(heart)
```

*Postaramy się odpowiedzieć na pytanie z jakim prawdopodobieństwem osoba mająca maksymalne osiągalne tętno wynoszące 150 uderzeń na minutę ma większą szansę na zawał serca.


*Ile osób powyżej 55 roku życia lub mająca 55 lat ma więszą szansę na atak serca? Ile osób ponież 55 roku życia ma większą szansę na zawał?


*Ustalimy czy istnieje asocjacja między większym lub mniejszym ryzykiem ataku serca, a zmiennymi age,sex,exng,trtbps,chol oraz thalachh.



W tym momencie sprawdźmy jak wygladają rozkłady naszych zmiennych. W tym miejscu tworzymy histogramy  jak również histogramy, w których logarytmujemy nasze predyktory, żeby od razu móc zobaczyć, czy wykresy poprawią się.

```{r}

age1 <- ggplot(data = heart, aes(x = age)) + geom_histogram()
age1_log <- ggplot(data = heart, aes(x = log2(age))) + geom_histogram()

trtbps1 <- ggplot(data = heart, aes(x = trtbps)) + geom_histogram()
trtbps1_log<-ggplot(data=heart, aes(x=log2(trtbps)))+geom_histogram()

chol1 <- ggplot(data = heart, aes(x = chol)) + geom_histogram()
chol1_log <- ggplot(data = heart, aes(x = log2(chol))) + geom_histogram()

thalach1 <- ggplot(data = heart, aes(x = thalachh)) + geom_histogram()
thalach1_log <- ggplot(data = heart, aes(x = log2(thalachh))) + geom_histogram()


grid.arrange(age1,age1_log,trtbps1,trtbps1_log,chol1,chol1_log,thalach1,thalach1_log,nrow=4)

```

Wniosek: Nałożenie logarytmu na nasze zmienne dały poprawę jedynie  dla zmiennej 'trtbps' i może nieznacznie dla zmiennej 'chol'. Ponadto  widzimy, że zmienna `chol` ma jedną wartość odstającą, którą możemy usunąć i nie wypłynie ona negatywnie na dalsze badania. Budując nasze modele zwrócimy uwagę, czy zmienna zlogarytmowana 'trtbps' oraz 'chol' poprawią wyniki modelu.



```{r}
heart <- heart[!heart$chol == 564,]
```


Patrząc na nieprzekształcony histogram zmiennej 'age' odpowiedzmy sobie na pytanie, ile osób bedących w wieku równym lub wyższym niż 55 ma większą możliwość ataku serca.

```{r}
wpow_55 <- heart[which(heart$age >= 55 & heart$output == 1), ]

length(wpow_55$output)
```

Są 64 osoby, które mają większą szanse na atak serca i są w wieku większym lub równym niż 55 lat

```{r}
wpow_55 <- heart[which(heart$age >= 55 & heart$output == 0), ]

length(wpow_55$output)
```

Natomiast liczba osób, które mają mniejszą szanse na atak serca wynosi 94.



Zobaczmy teraz ile osób ma większą szanse na atak serca, ale mają poniżej 55 lat.

```{r}
wpon_55 <- heart[which(heart$age < 55 & heart$output == 1), ]

length(wpon_55$output)
```

Mamy 100 takich osób.



```{r}
wpon_55 <- heart[which(heart$age < 55 & heart$output == 0), ]

length(wpon_55$output)
```

Przy czym liczba osób poniżej 55 roku życia z mniejszą szansą na atak serca wynosi 44.


```{r}
procent<- 64/(64+94)*100
procent

```

```{r}
procent2<-100/(100+44)*100
procent2

```

Wniosek: Około 40,5% osób powyżej bądź będacych w 55 roku życia ma większą szanse na atak serca, natomiast poniżej 55 roku większą możliwość zawału ma około 69% badanych. Zobaczmy jak będzie wyglądać krzywa logistyczna.


```{r}

ggplot(heart, aes(x = age, y = output)) + geom_point() + geom_smooth(method = "glm", method.args=list(family = "binomial")) + labs( x = "age",y = "output")

```

Można by było stwierdzić, że z naszych danych wynika, że wraz z wiekiem szansa na atak serca maleje, co nie jest zgodne z prawdą. Wynika to z małego zbioru danych i małej różnorodności badanych.



Teraz zbudujemy model.

```{r}
model_age<-glm(output~age,family = binomial,data = heart)
summary(model_age)

```

Wnioski: Jak możemy zauważyć zmienna 'age' jest istotna statystycznie. Istnieje związek między wiekiem a możliwością ataku serca. Współczynnik a jest mniejszy od zera, więc nasza krzywa jest malejąca. 

Dewiancja wynosi 399.93 i jest większa od 300 stopni swobody. Może to świadczyć o zjawisku nadmiernej dyspersji lub niedopasowaniu modelu. Jednakże, na razie się tym nie przejmujemy, ponieważ końcowy model będzie zawierał więcej niż jeden predyktor.



Teraz zobaczymy jak zmienna thalachh, która mówi o maksymalnym osiągalnym tętnie wpływa na szansę ataku serca. Odpowiemy sobie na pytanie ile osób, które miały maksymalne osiągalne tętno powyżej 150 ma większą możliwość zawału.

```{r}
thalpow_150 <- heart[which(heart$thalachh > 150 & heart$output == 1), ]

length(thalpow_150$output)
```

119 osób ma większą możliwość zawału i ma tętno maksymalne przekraczające 150 uderzeń na minutę.

```{r}
thalpow_150 <- heart[which(heart$thalachh > 150 & heart$output == 0), ]

length(thalpow_150$output)
```

44 osoby mające tętno przekraczające 150 ma mniejszą szanse na atak serca

```{r}
thalpon_150 <- heart[which(heart$thalachh < 150 & heart$output == 1), ]

length(thalpon_150$output)
```

43 osoby mają większą szansę na atak serca, jednak maksymalne tętno nie przekroczyło 150 uderzeń

```{r}
thalpon_150 <- heart[which(heart$thalachh < 150 & heart$output == 0), ]

length(thalpon_150$output)
```

Natomiast 89 osób ma mniejszą szansę na atak serca i tętno maksymalne nie wynosi więcej jak 150 uderzeń na minutę


Rysujemy krzywą logistyczną.

```{r}

ggplot(heart, aes(x = thalachh, y = output)) + geom_point() + geom_smooth(method = "glm", method.args=list(family = "binomial")) + labs(title = "Logistic Regression Model", x = "thalachh",y = "output")

```

Widzimy, że krzywa jest rosnąca. Czyli z naszych danych wynika, że im większe maksymalne tętno, tym większa szansa na zawał.
Zobaczmy, co na to nasz model.

```{r}

model_thalach<-glm(output~thalachh,family = binomial,data = heart)
summary(model_thalach)

```

Jak możemy zauważyć współczynnik a jest większy od zera, krzywa jest rosnąca. 

Dewiancja wynosi 358.41 i jest trochę wyższa niż liczba stopni swobody. Model wydaje się być w miarę dobrze dopasowany, zmienna thalachh jest istotna statystycznie.

Prawdopodobieństwo, że osoba mająca maksymalne osiągalne tętno wynoszące x ma większe lub mniejsze szanse na atak serca wyraża się następująco:

$$ exp(0.043802*thalachh - 6.374691)/1+exp(0.043802*thalachh -6.374691)  $$
 Zatem odpowiedmzy sobie na pytanie, jakie jest prawdopodobieństwo, że osoba, która ma maksymalne tętno wynoszące 150 ma większą szansę na atak serca.
 
```{r}
exp(0.043802*150-6.374691)/(1+exp(0.043802*150-6.374691))

```

Odp: Około 55% szansy na atak serca.

Dla pozostałych predyktorów sprawdzamy tylko czy są one istotne statystycznie, czy będziemy je wykorzystywać w końcowym modelu.

```{r}
model_sex<-glm(output~sex,family = binomial,data = heart)
summary(model_sex)

```


Sprawdzamy zależność zmiennej `sex` od `outcome`.

```{r}

heart %>% 
  group_by(sex) %>% 
  summarise(outcome_mean = mean(as.numeric(as.character(output)),
                                na.rm = TRUE))

```

Jak możemy zaobserwować płeć ma wpływ na zawał serca. Mężczyźni częściej mają atak serca.




```{r}
model_exng<-glm(output~exng,family = binomial,data = heart)
summary(model_exng)

```

Sprawdzamy wpływ zmiennej `exng` od `outcome`.

```{r}

heart %>% 
  group_by(exng) %>% 
  summarise(outcome_mean = mean(as.numeric(as.character(output)),
                                na.rm = TRUE))

```



```{r}
model_trtbps<-glm(output~trtbps,family = binomial,data = heart)
summary(model_trtbps)

```




```{r}
model_chol<-glm(output~chol,family = binomial,data = heart)
summary(model_chol)

```

Podsumowanie. Jak widzimy zmienne 'sex' oraz 'exng' są istotne statystycznie, istenieje asocjacja między nimi, a możliwością zawału. W naszej grupie badanych osób poziom cholesterolu nie ma znaczenia. Zobaczmy jak wyglądają wykresy diagnostyczne zmiennej chol.

```{r}

plot(model_chol)
```

Wniosek: nie będziemy zmiennej chol umieszczać w końcowym modelu.

Już teraz możemy stwierdzić, że nie wszystkie predyktory, o których zakładaliśmy, że mają wpływ na większą bądź mniejszą szansę ataku serca są rzeczywiście istotne statystycznie.


Sprawdźmy jeszcze zależność osób z dławicą piersiową od ataku serca.

```{r}
tab <- xtabs(~ exng + sex  + output, data = heart)
tab
```

Możemy zauważyć, że większość osób, którzy mieli atak serca są osobami bez dławicy piersiowej.




Spójrzmy na końcowy model

```{r}

model_koncowy<-glm(output~age+sex+ trtbps+thalachh,family = binomial,data = heart)
summary(model_koncowy)

```

Jak widzmy model wydaje się być dobrze dopasowany, chociaż zmienna p-value zmiennej age wynosi 0.2101. Dewiancja wynosi 323.09, aliczba stopni swobody 297. Wykonajmy jeszcze test Hosmera-Lameshowa.


```{r}
hoslem.test(heart$output, fitted(model_koncowy))


```
Model jest dobrze dopasowany


Natomiast zobaczmy jak będzie wyglądał model bez zmiennej 'age'.

```{r}

model_koncowy2<-glm(output~sex+trtbps+thalachh,family = binomial,data = heart)
summary(model_koncowy2)
```

Wykonajmy test Hosrema-Lameshowa.

```{r}

hoslem.test(heart$output, fitted(model_koncowy2))
```

p-value w tym przypadku jest większe niż dla poprzedniego modelu.

Zwróćmy jeszcze uwagę na przypuszczenie, które mamy na początku. Czy zmienna trtbps zlogarytmowana poprawi nam końcowy model?

```{r}
model_koncowy3<-glm(output~sex+log2(trtbps)+thalachh,family = binomial,data = heart)
summary(model_koncowy3)

```
```{r}

hoslem.test(heart$output, fitted(model_koncowy3))
```

Test Hosmera-Lameshowa wykazał, że poprzedni model był lepiej dopasowany

Ostatecznie naszym modelem zostaje "model_koncowy2"




Zobaczmy jak wyglądają wykresy diagnostyczne

```{r}

par(mfrow=c(2,2))
plot(model_koncowy2)

```

Wykresy diagnostyczne potwierdzają nasze przypuszczenia, model jest dobrze dopasowany.



```{r}

residu1 = c()
predictor1 = c()
for (i in 1:10) {
  res <- qresid(model_koncowy2)
  pred <- predict(model_koncowy2, type='response')
  residu1 = c(residu1, res)
  predictor1 = c(predictor1, pred)
  
}
scatter.smooth(predictor1, residu1, col='gray')
```

Reszty kwantylowe pozwalają na lepszą diagnostykę modelu. Możemy zaobserwować dobre dopasowanie modelu, co potwierdza poprzednie testy.










